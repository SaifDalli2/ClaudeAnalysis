<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comment Categorization System</title>
  <link rel="stylesheet" href="styles.css">
  <script src="js/industry-manager.js"></script>
  <script>
  // Enhanced integration with industry-specific categories
  
  // Initialize industry manager when app loads
  document.addEventListener('DOMContentLoaded', async function() {
    console.log('üè≠ Starting industry integration...');
    
    // Wait for authentication to be ready
    await new Promise(resolve => {
      if (window.currentUser !== undefined) {
        resolve();
      } else {
        const checkAuth = setInterval(() => {
          if (window.currentUser !== undefined) {
            clearInterval(checkAuth);
            resolve();
          }
        }, 100);
        
        // Timeout after 5 seconds
        setTimeout(() => {
          clearInterval(checkAuth);
          resolve();
        }, 5000);
      }
    });
    
    // Wait for industry manager to be available
    await new Promise(resolve => {
      if (window.industryManager) {
        resolve();
      } else {
        const checkManager = setInterval(() => {
          if (window.industryManager) {
            clearInterval(checkManager);
            resolve();
          }
        }, 100);
        
        // Timeout after 3 seconds
        setTimeout(() => {
          clearInterval(checkManager);
          console.warn('‚ö†Ô∏è Industry manager not found, continuing without it');
          resolve();
        }, 3000);
      }
    });
    
    // Initialize industry manager
    try {
      if (window.industryManager && typeof window.industryManager.initialize === 'function') {
        await window.industryManager.initialize();
        
        // Update UI with industry information
        window.industryManager.updateIndustryDisplay();
        
        // Add industry selector if user is authenticated
        if (window.isAuthenticated && window.isAuthenticated()) {
          addIndustrySelector();
        }
        
        console.log('‚úÖ Industry integration complete');
      } else {
        console.warn('‚ö†Ô∏è Industry manager not properly initialized');
      }
    } catch (error) {
      console.error('‚ùå Industry integration failed:', error);
    }
  });
  
  // Listen for authentication changes
  window.addEventListener('userAuthenticated', async function(event) {
    console.log('üîÑ User authenticated, updating industry settings...');
    
    if (window.industryManager && typeof window.industryManager.initialize === 'function') {
      // Reinitialize industry manager with user context
      await window.industryManager.initialize();
      window.industryManager.updateIndustryDisplay();
      
      // Add industry selector
      addIndustrySelector();
    }
  });
  
  // Listen for industry changes
  window.addEventListener('industryChanged', function(event) {
    console.log('üè≠ Industry changed to:', event.detail.industry);
    
    // Update any UI elements that depend on industry
    updateCategoryCount(event.detail.categories.length);
    showIndustryNotification(event.detail.industry);
  });
  
  // Enhanced comment processing with industry context
  if (typeof window.enhancedProcessComments === 'function') {
    window.originalProcessComments = window.enhancedProcessComments;
    window.enhancedProcessComments = async function(comments, useSimulation = false) {
      console.log('üöÄ Starting enhanced processing with industry context...');
      
      try {
        // Get industry-specific processing options
        let industryOptions = {
          industry: 'Default',
          categories: [],
          npsFactors: [],
          isUserIndustry: false
        };
        
        if (window.industryManager && typeof window.industryManager.getProcessingOptions === 'function') {
          industryOptions = window.industryManager.getProcessingOptions();
        }
        
        console.log(`üìä Processing ${comments.length} comments with ${industryOptions.industry} categories`);
        
        // Add industry information to the processing
        if (!useSimulation) {
          // For API processing, we'll pass industry info to the backend
          console.log(`üè≠ Using ${industryOptions.categories.length} ${industryOptions.industry} industry categories`);
          
          // Update progress display to show industry
          const progressMessage = document.getElementById('progressMessage');
          if (progressMessage) {
            progressMessage.textContent = `Processing with ${industryOptions.industry} categories...`;
          }
        }
        
        // Call the original processing function
        const result = await window.originalProcessComments(comments, useSimulation);
        
        // Add industry context to results
        if (result && industryOptions.industry !== 'Default') {
          console.log(`‚úÖ Processing completed using ${industryOptions.industry} industry categories`);
          
          // Add industry badge to results if it doesn't exist
          addIndustryBadgeToResults(industryOptions.industry);
        }
        
        return result;
        
      } catch (error) {
        console.error('‚ùå Enhanced processing failed:', error);
        throw error;
      }
    };
  }
  
  // Add industry selector for authenticated users
  function addIndustrySelector() {
    if (document.getElementById('industrySelector')) {
      return; // Already exists
    }
    
    const apiKeySection = document.querySelector('.api-key-section');
    if (!apiKeySection) return;
    
    // Check if industry manager is available
    if (!window.industryManager || typeof window.industryManager.getAvailableIndustries !== 'function') {
      console.warn('‚ö†Ô∏è Industry manager not available for selector');
      return;
    }
    
    const selectorDiv = document.createElement('div');
    selectorDiv.className = 'industry-selector';
    selectorDiv.style.cssText = `
      margin-top: 15px;
      padding: 10px;
      background: rgba(226, 255, 102, 0.05);
      border: 1px solid rgba(226, 255, 102, 0.2);
      border-radius: 4px;
    `;
    
    const industries = window.industryManager.getAvailableIndustries();
    const currentIndustry = window.industryManager.getCurrentIndustry();
    
    selectorDiv.innerHTML = `
      <label for="industrySelect" style="color: var(--dark-text); font-weight: 500; font-size: 14px; display: block; margin-bottom: 8px;">
        üè≠ Industry Categories:
      </label>
      <select id="industrySelect" style="
        width: 100%;
        padding: 8px;
        border: 1px solid var(--dark-border);
        border-radius: 4px;
        background: var(--dark-surface-lighter);
        color: var(--dark-text);
        font-size: 14px;
      ">
        ${industries.map(industry => 
          `<option value="${industry.name}" ${industry.name === currentIndustry ? 'selected' : ''}>
            ${industry.displayName || industry.name}
          </option>`
        ).join('')}
      </select>
      <div style="font-size: 12px; color: var(--dark-text-secondary); margin-top: 5px;">
        Choose your industry for specialized categorization
      </div>
    `;
    
    // Add event listener for industry changes
    const select = selectorDiv.querySelector('#industrySelect');
    select.addEventListener('change', async function() {
      const newIndustry = this.value;
      console.log(`üîÑ User selected industry: ${newIndustry}`);
      
      if (window.industryManager && typeof window.industryManager.switchIndustry === 'function') {
        await window.industryManager.switchIndustry(newIndustry);
        showIndustryNotification(newIndustry);
      }
    });
    
    apiKeySection.appendChild(selectorDiv);
  }
  
  // Update category count display
  function updateCategoryCount(count) {
    const categoryCount = document.getElementById('categoryCount');
    if (categoryCount) {
      categoryCount.textContent = count;
    }
  }
  
  // Show industry change notification
  function showIndustryNotification(industry) {
    // Create notification
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--dark-primary);
      color: black;
      padding: 12px 20px;
      border-radius: 6px;
      font-weight: 600;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    `;
    
    notification.textContent = industry === 'Default' 
      ? 'üìã Switched to general categories'
      : `üè≠ Switched to ${industry} categories`;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }
    }, 3000);
  }
  
  // Add industry badge to results
  function addIndustryBadgeToResults(industry) {
    const categoriesContainer = document.getElementById('categoriesContainer');
    if (!categoriesContainer || document.getElementById('industryResultsBadge')) {
      return; // Already exists or container not found
    }
    
    const badge = document.createElement('div');
    badge.id = 'industryResultsBadge';
    badge.style.cssText = `
      background: var(--dark-primary);
      color: black;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 20px;
      display: inline-block;
    `;
    
    badge.textContent = `üè≠ Results categorized using ${industry} industry categories`;
    
    categoriesContainer.insertBefore(badge, categoriesContainer.firstChild);
  }
  
  // Add CSS animations
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    
    .industry-info {
      transition: all 0.3s ease;
    }
    
    .industry-selector select:focus {
      outline: none;
      border-color: var(--dark-primary);
      box-shadow: 0 0 0 2px rgba(226, 255, 102, 0.2);
    }
  `;
  document.head.appendChild(style);
  
  console.log('üè≠ Industry integration script loaded');
</script>
  <!-- Load translations.js (non-module) first -->
  <script src="js/translations.js"></script>
</head>
<body>
  <header class="header">
    <div class="logo-container">
      <div class="logo-section">
        <!-- Smaller, cleaner logo -->
        <img src="img/logo.png" alt="Logo" class="logo-image">
        
        <!-- User info (shown when logged in) -->
        <div id="userInfo" class="user-info" style="display: none;">
          <span id="welcomeMessage" class="welcome-message"></span>
          <span id="industryBadge" class="industry-badge"></span>
        </div>
      </div>
      
      <div class="header-controls">
        <!-- Language Switcher -->
        <div class="language-switcher">
          <select id="languageSelector">
            <option value="en">English</option>
            <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          </select>
        </div>
        
        <!-- User Menu (shown when logged in) -->
        <div id="userMenu" class="user-menu" style="display: none;">
          <button id="profileBtn" class="profile-btn">
            <span id="userInitials" class="user-initials"></span>
          </button>
          <div id="userDropdown" class="user-dropdown">
            <div class="dropdown-header">
              <div id="userFullName" class="user-full-name"></div>
              <div id="userEmail" class="user-email"></div>
            </div>
            <hr class="dropdown-divider">
            <button id="editProfileBtn" class="dropdown-item">
              <span data-lang-key="edit-profile">Edit Profile</span>
            </button>
            <button id="logoutBtn" class="dropdown-item logout">
              <span data-lang-key="logout">Logout</span>
            </button>
          </div>
        </div>
        
        <!-- Login Button (shown when not logged in) -->
        <div id="loginPrompt" class="login-prompt">
          <a href="/login" class="login-link" data-lang-key="login">Login</a>
          <span class="separator">|</span>
          <a href="/register" class="register-link" data-lang-key="register">Register</a>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="input-section">
      <h1 data-lang-key="app-title">Comment Categorization System</h1>
      <p data-lang-key="app-description">Enter comments to be categorized and summarized. Each comment will be assigned to exactly one category.</p>
      
      <!-- Simplified API Key Section -->
      <div class="api-key-section">
        <div class="api-key-input-group">
          <label for="apiKeyInput" data-lang-key="api-key">Claude API Key:</label>
          <input type="password" id="apiKeyInput" data-lang-key="api-key-placeholder" placeholder="Enter your Claude API key">
        </div>
        <p class="api-key-note" data-lang-key="api-key-storage">Your API key is stored locally in your browser only.</p>
      </div>
      
      <div class="tabs">
        <div class="tab active" data-tab="manual-entry" data-lang-key="manual-entry">Manual Entry</div>
        <div class="tab" data-tab="csv-upload" data-lang-key="csv-upload">CSV Upload</div>
      </div>
      
      <div class="tab-content active" id="manual-entry">
        <h3 data-lang-key="add-comment">Add Comment</h3>
        <textarea id="commentInput" data-lang-key="comment-placeholder" placeholder="Type your comment here..."></textarea>
        <button id="addCommentBtn" data-lang-key="add-comment-btn">Add Comment</button>
      </div>
      
      <div class="tab-content" id="csv-upload">
        <h3 data-lang-key="upload-csv">Upload CSV File</h3>
        <div class="file-upload">
          <label for="csvFileInput" data-lang-key="select-csv">Select a CSV file with comments (one comment per line or in a 'comment' column):</label>
          <input type="file" id="csvFileInput" accept=".csv">
          <div class="file-info" id="fileInfo"></div>
        </div>
        <button id="loadCsvBtn" data-lang-key="load-csv">Load Comments from CSV</button>
      </div>
      
      <h3 data-lang-key="comments-list">Comments List</h3>
      <div class="comment-list" id="commentsList"></div>
      
      <div class="action-buttons">
        <button id="clearCommentsBtn" data-lang-key="clear-comments">Clear All Comments</button>
        <button id="processCommentsBtn" class="primary-button" data-lang-key="process-comments">Process Comments</button>
      </div>

      <!-- Minimal Progress Indicator -->
      <div id="processingProgress" class="minimal-progress">
        <div class="progress-content">
          <div class="progress-info">
            <span class="progress-text" id="progressMessage">Processing...</span>
            <span class="progress-percentage" id="progressPercentage">0%</span>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar"></div>
          </div>
          <button class="cancel-btn" id="cancelJobBtn">Cancel</button>
        </div>
      </div>

      <!-- Hidden Debug Elements (only visible in development) -->
      <div id="debugElements" style="display: none;">
        <div class="system-status">
          <h4>System Status</h4>
          <div class="status-grid">
            <div class="status-item">
              <span class="status-label">API Server:</span>
              <span id="apiStatus" class="status-value status-checking">Checking...</span>
            </div>
            <div class="status-item">
              <span class="status-label">Comments Loaded:</span>
              <span id="commentCount" class="status-value">0</span>
            </div>
            <div class="status-item">
              <span class="status-label">Last Processed:</span>
              <span id="lastProcessed" class="status-value">Never</span>
            </div>
          </div>
        </div>

        <div class="debug-panel">
          <h4>Debug Controls</h4>
          <button id="debugBtn">üêõ Enable Debug Mode</button>
          <button id="testDisplayBtn">üß™ Test Display</button>
          <button id="clearConsoleBtn">üßπ Clear Console</button>
          <div id="debugInfo"></div>
        </div>

        <div class="debug-log" id="debugLog"></div>
      </div>
    </div>
    
    <div class="results-section">
      <h2 data-lang-key="categorized-comments">Categorized Comments</h2>
      <div class="result-info" data-lang-key="result-info">Each comment is assigned to exactly one category based on its primary topic or sentiment.</div>
      
      <div id="overallStats" class="overall-stats" style="display: none;">
        <h3 data-lang-key="overall-stats">Overall Statistics</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalComments">0</div>
            <div class="stat-label" data-lang-key="total-comments">Total Comments</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="categoryCount">0</div>
            <div class="stat-label" data-lang-key="categories">Categories</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="avgSentiment">0.0</div>
            <div class="stat-label" data-lang-key="avg-sentiment">Avg. Sentiment</div>
          </div>
        </div>
      </div>
      
      <div id="categoriesContainer"></div>
    </div>
  </div>

  <!-- Load debug helper script (hidden by default) -->
  <script src="js/debug-helper.js" style="display: none;"></script>

  <!-- SINGLE MODULE IMPORT -->
  <script type="module">
    import { initializeApp } from './js/module-index.js';
  </script>

  <!-- Enhanced comment counter and utilities -->
  <script>
    function updateCommentCount() {
      const count = window.comments ? window.comments.length : 0;
      const commentCountEl = document.getElementById('commentCount');
      if (commentCountEl) {
        commentCountEl.textContent = count;
      }
    }

    function updateLastProcessed() {
      const lastProcessedEl = document.getElementById('lastProcessed');
      if (lastProcessedEl) {
        lastProcessedEl.textContent = new Date().toLocaleTimeString();
      }
    }

    window.updateCommentCount = updateCommentCount;
    window.updateLastProcessed = updateLastProcessed;

    // Auto-update comment count
    setInterval(updateCommentCount, 1000);

    // Show debug elements only in development
    function toggleDebugElements() {
      const debugElements = document.getElementById('debugElements');
      const isDevelopment = window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1' ||
                           window.location.search.includes('debug=true');
      
      if (isDevelopment || window.location.search.includes('debug=true')) {
        debugElements.style.display = 'block';
        console.log('üîß Debug mode enabled');
      }
    }

    // Check for debug mode
    document.addEventListener('DOMContentLoaded', toggleDebugElements);

    // Secret key combination to enable debug in production (Ctrl+Shift+D)
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        const debugElements = document.getElementById('debugElements');
        debugElements.style.display = debugElements.style.display === 'none' ? 'block' : 'none';
        console.log('üîß Debug mode toggled via keyboard shortcut');
      }
    });
  </script>

  <!-- COMPLETE FIXED Authentication Integration Script -->
  <script>
    console.log('üöÄ Loading complete authentication fix...');

    window.currentUser = null;
    window.authToken = null;

    window.isAuthenticated = function() {
      return window.currentUser !== null && window.authToken !== null;
    };

    window.getCurrentUser = function() {
      return window.currentUser;
    };

    window.getAuthHeaders = function() {
      const headers = { 'Content-Type': 'application/json' };
      if (window.authToken) {
        headers['Authorization'] = `Bearer ${window.authToken}`;
      }
      return headers;
    };

    function waitForElement(selector, callback, maxAttempts = 20) {
      let attempts = 0;
      
      function check() {
        const element = document.getElementById(selector) || document.querySelector(selector);
        if (element) {
          callback(element);
        } else {
          attempts++;
          if (attempts < maxAttempts) {
            setTimeout(check, 250);
          }
        }
      }
      
      check();
    }

    async function initializeAuthentication() {
      const token = localStorage.getItem('authToken');
      const userInfo = localStorage.getItem('user');

      if (token && userInfo) {
        try {
          const response = await fetch('/api/auth/verify', {
            headers: { 'Authorization': `Bearer ${token}` }
          });

          if (response.ok) {
            const data = await response.json();
            window.currentUser = data.user;
            window.authToken = token;
            
            showUserInterface(data.user);
          } else {
            clearAuthData();
            showLoginPrompt();
          }
        } catch (error) {
          clearAuthData();
          showLoginPrompt();
        }
      } else {
        showLoginPrompt();
      }
    }

    function showUserInterface(user) {
      waitForElement('loginPrompt', (element) => {
        element.style.display = 'none';
      });
      
      waitForElement('userMenu', (element) => {
        element.style.display = 'block';
      });
      
      waitForElement('userInfo', (element) => {
        element.style.display = 'flex';
      });

      updateUserDisplay(user);
    }

    function showLoginPrompt() {
      waitForElement('loginPrompt', (element) => {
        element.style.display = 'flex';
      });
      
      waitForElement('userMenu', (element) => {
        element.style.display = 'none';
      });
      
      waitForElement('userInfo', (element) => {
        element.style.display = 'none';
      });
    }

    function updateUserDisplay(user) {
      waitForElement('welcomeMessage', (element) => {
        const firstName = user.firstName || user.email.split('@')[0];
        const currentLang = (typeof getCurrentLanguage === 'function') ? getCurrentLanguage() : 'en';
        
        if (currentLang === 'ar') {
          element.textContent = `ŸÖÿ±ÿ≠ÿ®ÿßŸãÿå ${firstName}!`;
        } else {
          element.textContent = `Welcome, ${firstName}!`;
        }
      });

      waitForElement('industryBadge', (element) => {
        if (user.industry) {
          element.textContent = user.industry;
          element.style.display = 'inline-block';
        } else {
          element.style.display = 'none';
        }
      });

      waitForElement('userInitials', (element) => {
        const initials = getInitials(user.firstName, user.lastName, user.email);
        element.textContent = initials;
      });

      waitForElement('userFullName', (element) => {
        const fullName = [user.firstName, user.lastName].filter(Boolean).join(' ') || 'User';
        element.textContent = fullName;
      });
      
      waitForElement('userEmail', (element) => {
        element.textContent = user.email;
      });
    }

    function getInitials(firstName, lastName, email) {
      if (firstName && lastName) {
        return (firstName[0] + lastName[0]).toUpperCase();
      } else if (firstName) {
        return firstName.substring(0, 2).toUpperCase();
      } else {
        return email.substring(0, 2).toUpperCase();
      }
    }

    function clearAuthData() {
      localStorage.removeItem('authToken');
      localStorage.removeItem('user');
      window.currentUser = null;
      window.authToken = null;
    }

    function setupUserInterface() {
      waitForElement('profileBtn', (profileBtn) => {
        waitForElement('userDropdown', (userDropdown) => {
          profileBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const isShown = userDropdown.classList.contains('show');
            
            if (isShown) {
              userDropdown.classList.remove('show');
            } else {
              userDropdown.classList.add('show');
            }
          });
        });
      });

      document.addEventListener('click', function(e) {
        waitForElement('userDropdown', (userDropdown) => {
          if (!e.target.closest('.user-menu')) {
            userDropdown.classList.remove('show');
          }
        });
      });

      waitForElement('logoutBtn', (logoutBtn) => {
        logoutBtn.addEventListener('click', async function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          try {
            await fetch('/api/auth/logout', {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${window.authToken}` }
            });
          } catch (error) {
            console.error('Logout API call failed:', error);
          }

          clearAuthData();
          
          const userMenu = document.getElementById('userMenu');
          const userInfo = document.getElementById('userInfo');
          const loginPrompt = document.getElementById('loginPrompt');
          const userDropdown = document.getElementById('userDropdown');
          
          if (userMenu) userMenu.style.display = 'none';
          if (userInfo) userInfo.style.display = 'none';
          if (userDropdown) userDropdown.classList.remove('show');
          if (loginPrompt) loginPrompt.style.display = 'flex';
          
          const welcomeMessage = document.getElementById('welcomeMessage');
          const userInitials = document.getElementById('userInitials');
          const userFullName = document.getElementById('userFullName');
          const userEmail = document.getElementById('userEmail');
          const industryBadge = document.getElementById('industryBadge');
          
          if (welcomeMessage) welcomeMessage.textContent = '';
          if (userInitials) userInitials.textContent = '';
          if (userFullName) userFullName.textContent = '';
          if (userEmail) userEmail.textContent = '';
          if (industryBadge) {
            industryBadge.textContent = '';
            industryBadge.style.display = 'none';
          }
          
          const categoriesContainer = document.getElementById('categoriesContainer');
          if (categoriesContainer) categoriesContainer.innerHTML = '';
          
          if (window.comments) window.comments.length = 0;
          
          const commentsList = document.getElementById('commentsList');
          if (commentsList) commentsList.innerHTML = '';
        });
      });
    }

    function handleLanguageChange() {
      if (window.currentUser) {
        updateUserDisplay(window.currentUser);
      }
    }

    function initialize() {
      setupUserInterface();
      initializeAuthentication();
      
      waitForElement('languageSelector', (languageSelector) => {
        languageSelector.addEventListener('change', () => {
          setTimeout(handleLanguageChange, 100);
        });
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialize);
    } else {
      setTimeout(initialize, 100);
    }
  </script>


</body>
</html>